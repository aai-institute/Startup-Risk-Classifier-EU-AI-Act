<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Risk Classifier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>

    <style>
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>

  <body>
    <h2>Risk Classification Tool</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <label for="file1">Upload Excel File (.xlsx only):</label>
      <p>The excel file should have two columns. The first column should have the startup names. The second column should have the website links</p>
      <input type="file" name="file1" id="file1" accept=".xlsx" required /><br /><br />

      <label for="file2">Upload Word File (.docx only):</label>
      <p>The word file should describe which AI Use Cases (or AI Systems) fall under Prohibited, High Risk, Limited Risk and Minimal Risk according to the EU AI Act. This bot attaches the following instruction right after your prompt:</p>
      <p>
        Format you answer in this way:  
        AI Use Case: 
        Use Case Description: 
        Risk Classification: 
        Reason: [Cite the relevant articles and annexes from the prompts above in your explanation]
        Confidence Level: [How confident are you in your current classification? Pick a value from 0-100%]
        Requires Additional Information: [If you have doubts about this classification, write Yes/No followed by what additional informtaion is absolutely necessary without which you can't be sure about the classification]

        Do not give any intros or outros. The following are the AI Use cases of the startup you have to classify using all of the above rules:  
        {`The AI Startup Use Cases will be listed here`}
      </p>
      <input type="file" name="file2" id="file2" accept=".docx" required /><br /><br />

      <button type="submit">Upload Files</button>
    </form>

    <div id="response"></div>

    <div class="output-container" style="margin-top: 50px">
      <h2>Processing Logs:</h2>
      <div id="output" style="background-color: #f5f5f5; padding: 10px; margin-top: 10px; border: 1px solid #ddd"></div>

      <button id="downloadBtn" style="margin-top: 20px" disabled="true">Download File</button>
    </div>

    <script>
      // Handle running the long process and streaming output
      const outputs = () => {
        $("#output").html(""); // Clear previous output
        var eventSource = new EventSource("/run_process");

        eventSource.onmessage = function (event) {
          $("#output").append("<p>" + event.data + "</p>");

          // Check if the last message contains "Processing complete!"
          if (event.data.includes("Processing complete!")) {
            $("#downloadBtn").prop("disabled", false);
            eventSource.close(); // Close the stream when complete
          }
        };

        eventSource.onerror = function () {
          eventSource.close();
          $("#downloadBtn").prop("disabled", false); // Enable download button on error (to be safe)
        };
      };

      $("#downloadBtn").click(function () {
        window.location.href = "/download";
      });

      $(document).ready(function () {
        // Handle file upload
        $("#uploadForm").submit(function (event) {
          event.preventDefault();

          var formData = new FormData();
          formData.append("file1", $("#file1")[0].files[0]);
          formData.append("file2", $("#file2")[0].files[0]);

          $.ajax({
            url: "/upload",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              $("#response").html("<p style='color: green;'>" + response.message + "</p>");
              $("#uploadForm :input").prop("disabled", true);
              outputs();
            },
            error: function (xhr) {
              var errorMsg = JSON.parse(xhr.responseText).error;
              $("#response").html("<p style='color: red;'>" + errorMsg + "</p>");
            },
          });
        });
      });
    </script>
  </body>
</html>
